name: Terraform Format & Security

on:
  push:
    branches-ignore:
      - main
    paths:
      - "infra/**"
      - ".github/workflows/terraform-format-security.yml"

jobs:
  format:
    name: Terraform Format
    uses: ./.github/workflows/reusable-terraform-format.yml
    permissions:
      contents: write
    with:
      working_directory: "infra"
      terraform_version: "1.14.3"
      enable_auto_commit: true
    secrets: inherit

  security:
    name: Security Analysis (tfsec)
    needs: format
    if: always() && needs.format.result == 'success'
    uses: ./.github/workflows/reusable-terraform-security.yml
    permissions:
      contents: read
    with:
      working_directory: "infra"
      tfsec_soft_fail: false
    secrets: inherit
